//==============================================================================
//
//  Copyright 2021 TOBESOFT Co., Ltd.
//  All Rights Reserved.
//
//  NOTICE: TOBESOFT permits you to use, modify, and distribute this file 
//          in accordance with the terms of the license agreement accompanying it.
//
//  Readme URL: http://www.nexacro.com/legal/license/tobesoft/ko/NexacroN-public-license-readme-1.1.html
//
//==============================================================================
if(!nexacro.XAgent){"use strict";nexacro.XAgentEventInfo=function(_a,_b,_c,_d,_e,_f,_g){this.obj=_a;this.eventid=_b;this.statusmessage=_c;this.reason=_d;this.param=_e;this.modulename=_f;this.modulefunc=_g;};var _pXAgentEventInfo=nexacro._createPrototype(nexacro.Event,nexacro.XAgentEventInfo);nexacro.XAgentEventInfo.prototype=_pXAgentEventInfo;_pXAgentEventInfo._type_name="XAgentEventInfo";delete _pXAgentEventInfo;_pXAgentEventInfo=null;nexacro.XAgentErrorEventInfo=function(_a,_b,_c,_d,_e){this.obj=_a;this.eventid=_b;this.errormsg=_d;this.errorcode=_c;this.data=_e;};var _pXAgentErrorEventInfo=nexacro._createPrototype(nexacro.Event,nexacro.XAgentErrorEventInfo);nexacro.XAgentErrorEventInfo.prototype=_pXAgentErrorEventInfo;_pXAgentErrorEventInfo._type_name="XAgentErrorEventInfo";delete _pXAgentErrorEventInfo;_pXAgentErrorEventInfo=null;nexacro.XAgent=function(_a,_b){nexacro._EventSinkObject.call(this,_a,_b);};var _pXAgent=nexacro._createPrototype(nexacro._EventSinkObject,nexacro.XAgent);nexacro.XAgent.prototype=_pXAgent;_pXAgent._type_name="XAgent";_pXAgent._p_port=49020;_pXAgent._p_protocol="ws";_pXAgent._p_addport=5;_pXAgent._p_project="";_pXAgent._p_license="";_pXAgent._p_updateurl="";_pXAgent._p_adminapiurl="";_pXAgent._isConnect=false;_pXAgent._host="127.0.0.1";_pXAgent._basePath="XAgent";_pXAgent._protocolIdx=0;_pXAgent._basePort=[49020,49031];_pXAgent._currentPort=49020;_pXAgent._socket=null;_pXAgent._socket_data=[];_pXAgent._svcId="";_pXAgent._module=null;_pXAgent._modulefn=null;_pXAgent._param={};_pXAgent._event_list={"onsuccess":1,"onerror":1};_pXAgent.destroy=function(){if(this._socket){this.disconnect();}this._socket_data=null;this._socket=null;this._svcId=null;this._module=null;this._modulefn=null;this._param=null;if(this._p_parent){this._p_parent.removeChild(this.id);}nexacro._EventSinkObject.prototype.destroy.call(this);};_pXAgent._default_service_errorcode={"connect":-101,"update-module":-201,"update-modules":-301,"update-module-check":-401,"installed":-501,"status":-601,"version":-701,"configure":-801,"exception":-901,"execute":-1001};_pXAgent._errortable={"-101":"object_xagent_fail_connect","-102":"object_xagent_fail_disconnect","-103":"object_xagent_fail_communication_retry","-104":"object_xagent_fail_connection_reinstall","-105":"object_xagent_fail_invalid_service_format","-106":"object_xagent_fail_socket_unconnect","-107":"object_xagent_fail_connection_retry","-108":"object_xagent_fail_port_retry","-201":"object_xagent_fail_module_update","-202":"object_xagent_error_invalid_url","-203":"object_xagent_fail_update_version_check","-204":"object_xagent_fail_update_download","-205":"object_xagent_fail_delete_directory","-206":"object_xagent_fail_decompression","-207":"object_xagent_fail_delete_temp_directory","-301":"object_xagent_fail_modules_update","-303":"object_xagent_fail_found_json_file","-304":"object_xagent_fail_module_download","-401":"object_xagent_fail_update_module_check","-501":"object_xagent_fail_installed","-601":"object_xagent_fail_check_status","-701":"object_xagent_fail_check_version","-704":"object_xagent_fail_found_server","-705":"object_xagent_fail_found_modules","-801":"object_xagent_fail_configure","-804":"object_xagent_fail_found_project","-805":"object_xagent_fail_found_license","-806":"object_xagent_fail_license","-807":"object_xagent_fail_found_updateurl","-1001":"object_xagent_fail_execute","-1002":"object_xagent_error_unknown","-1003":"object_xagent_error_argument","-1004":"object_xagent_fail_found_module_execute","-1005":"object_xagent_fail_found_func_execute","-1006":"object_xagent_fail_found_param","-1007":"object_xagent_error_json_parsing"};_pXAgent.set_port=function(_a){if(_a===undefined||_a===null){return;}_a=nexacro._toInt(_a);if(_a!=this._p_port){this._currentPort=this._p_port=_a;}};_pXAgent.set_protocol=function(_a){if(_a==="undefined"||_a===null||_a===""){return true;}var _b=["ws","wss"];if(_b.indexOf(_a)==-1){return false;}if(_a!=this._p_protocol){this._p_protocol=_a;}};_pXAgent.set_addport=function(_a){_a=nexacro._toInt(_a);if(_a!=this._p_addport){this._p_addport=_a;}};_pXAgent.set_project=function(_a){if(_a==="undefined"||_a===null||_a===""){return true;}if(_a!=this._p_project){this._p_project=_a;}};_pXAgent.set_license=function(_a){if(_a==="undefined"||_a===null||_a===""){return true;}if(_a!=this._p_license){this._p_license=_a;}};_pXAgent.set_updateurl=function(_a){if(_a==="undefined"||_a===null||_a===""){return true;}if(_a!=this._p_updateurl){this._p_updateurl=_a;}};_pXAgent.set_adminapiurl=function(_a){if(_a==="undefined"||_a===null||_a===""){return true;}if(_a!=this._p_adminapiurl){this._p_adminapiurl=_a;}};_pXAgent.connect=function(_a,_b,_c,_d){if(this._isConnect){this._on_success("object_xagent_success_connect","connect",null,"XAgent","connect");return;}if(!_a){_a=this._p_project;}if(!_b){_b=this._p_license;}if(!_c){_c=this._p_updateurl;}if(!_d){_d=this._p_adminapiurl;}var _e=["ws","wss"];if(_e.indexOf(this._p_protocol)==-1){var _f=this._getErrorCode(serviceId);this._on_error(_f,null);return;}else{var _g=this._p_protocol=="wss"?1:0;this._protocolIdx=_g;if(!this._p_port){this._p_port=this._basePort[_g];}this._currentPort=this._p_port;this._param={"project":_a,"license":_b,"updateUrl":_c,"adminApiUrl":_d};this._connectXAgent();}};_pXAgent._connectXAgent=function(){var _a=this._socket=new WebSocket(this._p_protocol+"://"+this._host+":"+this._currentPort+"/"+this._basePath+"?tm="+new Date().getTime());_a.onopen=this._bindOpenHandler(this);_a.onmessage=this._bindMessageHandler(this);_a.onerror=this._bindErrorHandler(this);_a.onclose=this._bindCloseHandler(this);};_pXAgent.disconnect=function(){if(this._socket){this._socket.onopen=null;this._socket.onmessage=null;this._socket.onerror=null;this._socket.onclose=null;this._socket.close();this._socket=null;this._isConnect=false;this._svcId=null;this._module=null;this._modulefn=null;this._param=null;this._socket_data=[];this._on_success("object_xagent_success_disconnect","disconnect",null,null,null);}else{this._on_error(-102,null);}};_pXAgent.version=function(_a){var _b="version";if(_a===undefined||_a===null||_a===""){_a="all";}if(_a!=="server"&&_a!=="modules"&&_a!=="all"){var _c=this._getErrorCode(_b);this._on_error(_c,null);return;}if(this._isConnect){this._param={"type":_a};this._callService(_b,"XAgent","version",this._param);}else{var _c=this._getErrorCode(_b);this._on_error(_c,null);}};_pXAgent.installed=function(_a,_b){var _c="installed";if(_a===undefined||_a===null||_a===""||_b===undefined||_b===null||_b===""){var _d=this._getErrorCode(_c);this._on_error(_d,null);return;}if(this._isConnect){this._param={"registry-path":_a,"registry-key":_b};this._callService(_c,"XAgent","installed",this._param);}else{var _d=this._getErrorCode(_c);this._on_error(_d,null);}};_pXAgent.configure=function(_a,_b,_c,_d){var _e="configure";if(_a===undefined||_a===null||_a===""||_b===undefined||_b===null||_b===""||_c===undefined||_c===null||_c===""){var _f=this._getErrorCode(_e);this._on_error(_f,null);return;}if(_d===undefined||_d===null||_d===""){_d="";}if(this._isConnect){this._param={"project":_a,"license":_b,"updateurl":_c,"adminapiurl":_d};this._callService(_e,"XAgent","configure",this._param);}else{var _f=this._getErrorCode(_e);this._on_error(_f,null);}};_pXAgent.updateModule=function(_a,_b,_c,_d,_e){var _f="update-module";if(_a===undefined||_a===null||_a===""||_b===undefined||_b===null||_b===""||_c===undefined||_c===null||_c===""||_d===undefined||_d===null||_d===""){var _g=this._getErrorCode(_f);this._on_error(_g,null);return;}if(_e===undefined||_e===null||_e===""){_e=false;}if(this._isConnect){this._param={"name":_a,"version":_b,"file":_c,"project":_d,"force-install":_e};this._callService(_f,"XAgent","update-module",this._param);}else{var _g=this._getErrorCode(_f);this._on_error(_g,null);}};_pXAgent.updateModules=function(_a){var _b="update-modules";if(_a===undefined||_a===null||_a===""){var _c=this._getErrorCode(_b);this._on_error(_c,null);return;}if(this._isConnect){this._param={"project":_a};this._callService(_b,"XAgent","update-modules",this._param);}else{var _c=this._getErrorCode(_b);this._on_error(_c,null);}};_pXAgent.updateModuleCheck=function(){var _a="update-module-check";if(this._isConnect){this._callService(_a,"XAgent","update-module-check",{});}else{var _b=this._getErrorCode(_a);this._on_error(_b,null);}};_pXAgent.status=function(_a){var _b="status";if(_a===undefined||_a===null||_a===""){_a="all";}if(_a!=="server"&&_a!=="process"&&_a!=="all"){var _c=this._getErrorCode(_b);this._on_error(_c,null);return;}if(this._isConnect){this._param={"type":_a};this._callService(_b,"XAgent","status",this._param);}else{var _c=this._getErrorCode(_b);this._on_error(_c,null);}};_pXAgent.execute=function(_a,_b,_c){var _d="execute";if(_a===undefined||_a===null||_a===""||_b===undefined||_b===null||_b===""){var _e=this._getErrorCode(_d);this._on_error(_e,null);return;}if(this._isConnect){this._param=_c||{};this._callService(_d,_a,_b,this._param);}else{var _e=this._getErrorCode(_d);this._on_error(_e,null);}};_pXAgent.on_fire_onsuccess=function(_a,_b,_c,_d,_e){if(this.onsuccess&&this.onsuccess._has_handlers){var _f=new nexacro.XAgentEventInfo(this,"onsuccess",_a,_b,_c,_d,_e);return this.onsuccess._fireEvent(this,_f);}return true;};_pXAgent.on_fire_onerror=function(_a,_b,_c){if(this.onerror&&this.onerror._has_handlers){var _d=new nexacro.XAgentErrorEventInfo(this,"onerror",_a,_b,_c);return this.onerror._fireEvent(this,_d);}};_pXAgent._on_success=function(_a,_b,_c,_d,_e){var _f=nexacro._getErrorMessge(_a);this.on_fire_onsuccess(_f?_f:_a,_b,_c,_d,_e);};_pXAgent._on_error=function(_a,_b){var _c=this._getErrorMessage(_a);this.on_fire_onerror(_a,_c,_b);};_pXAgent._callService=function(_a,_b,_c,_d){if(this._isConnect==false&&_a!="connect"){this._on_error(-106,null);return;}var _e=_a;var _f=_b;var _g=_c;var _h=_d||{};var _i=this._setUUID(_e);var _j={};switch(_e){case "connect":case "installed":case "version":case "update-module":case "update-module-check":case "update-modules":case "status":case "configure":case "execute":_j[_e]={"module":_f,"func":_g,"uid":_i,"param":_h};break;default:_j["request"]={"module":_f,"func":_g,"uid":_i,"param":_h};break;}this._module=_f;this._svcId=_e;this._modulefn=_g;this._param=_h;this._socket.send(JSON.stringify(_j));};_pXAgent._getErrorCode=function(_a){var _b=this._default_service_errorcode[_a];if(nexacro._isNull(_b)){return -1002;}else{return _b;}};_pXAgent._getErrorMessage=function(_a){var _b=this._errortable[_a];if(nexacro._isNull(_b)){return "";}else{return nexacro._getErrorMessge(_b);}};_pXAgent._checkPort=function(){var _a=this._p_port+this._p_addport;if(this._currentPort>=_a){this._currentPort=this._p_port;return false;}else{this._currentPort++ ;return true;}};_pXAgent._createUUID=function(){var _a=new Date().getTime();var _b="xx_yx";var _c=_a+"_"+_b.replace(/[xy]/g,function(_d){var _e=(nexacro._random()* 16)|0;var _f=_d=="x"?_e:(_e&0x3)|0x8;return _f.toString(16);});return _c;};_pXAgent._setUUID=function(_a){var _b=this._createUUID();this._socket_data.push({"uid":_b,"svc":_a});return _b;};_pXAgent._getUUID=function(_a){var _b=this._socket_data;for(var _d=0;_d<_b.length;_d++ ){if(_b[_d].uid==_a){var _c=_b[_d].svc;return {"svc":_c};}}return {};};_pXAgent._bindOpenHandler=function(_a){return function(_b){_a._isConnect=true;if(_a._module&&_a._module.length>0){_a._callService(_a._svcId,_a._module,_a._modulefn,_a._param);}else{_a._callService("connect","XAgent","connect",_a._param);}};};_pXAgent._bindMessageHandler=function(_a){return function(_b){if(_b&&_b.data){var _c=JSON.parse(_b.data);if(_c&&_c.response){var _d=_c.response;var _e=Object.keys(_d)[0];var _f={},_g="",_h=null,_i=null,_j="";if(_e){_f=_d[_e];}_g=_a._getUUID(_f.uid).svc;_h=_f.result;_i=_f.param;_j=_f.module;modulefunc=_f.func;switch(_e){case "connect":if(_i){_a._isConnect=true;_a._on_success("object_xagent_success_connect","connect",_i,_j,modulefunc);}else{_a._on_error(_h[0],_b.data);}break;case "installed":case "version":case "update-module":case "update-module-check":case "update-modules":case "status":case "configure":case "execute":if(_h[0]==0){_a._on_success(_h[1],_e,_i,_j,modulefunc);}else{_a._on_error(_h[0],_b.data);}break;case "event":var _k=_f.eventid;var _l=_f.eventdata;var _i=[_k,_l];if(_h[0]==0){_a._on_success("",_e,_i,_j,modulefunc);}else{_a._on_error("",_i);}break;default:_a._on_error(-105,_b.data);break;}}}};};_pXAgent._bindErrorHandler=function(_a){return function(_b){_a._on_error(-103,_b);};};_pXAgent._bindCloseHandler=function(_a){return function(_b){if(_a._isConnect){_a._on_error(-107,null);_a._isConnect=false;}else{if(!_a._checkPort()){_a._on_error(-104,null);}else{_a._on_error(-108,null);_a._socket=null;_a._connectXAgent();}}};};_pXAgent._getStatus=function(){if(!this._socket){return "CLOSED";}switch(this._socket.readyState){case 1:return "OPEN";case 2:return "CLOSE";case 3:return "CLOSED";default:return "CONNECTING";}};_pXAgent._properties=[{name:"port"},{name:"protocol"},{name:"addport"},{name:"project"},{name:"license"},{name:"updateurl"},{name:"adminapiurl"}];nexacro._defineProperties(_pXAgent,_pXAgent._properties);delete _pXAgent;}